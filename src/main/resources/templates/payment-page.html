<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payment Page</title>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="row">
          <div class="col-md-6 col-md-offset-3">
              <center>
                  <br />
                  <br />
                  <h1>Proceed to Payment</h1>
              </br>
              </center>
              <ul>
                <li>Number of Passenger = <span id="number-passenger"></span></li>
                <li>Selected Classes = <span id="selected-classes"></span></li>
                <li>Total Price  = <span id="price"></span></li>
              </ul>
              <br/>
              <br/>
              <!-- <form> -->
                  <div class="form-group">
                      <label for="price">Total Price:</label>
                      <input type="text" class="form-control" id="input-price" />
                  </div>
            
                  <div class="form-group">
                    <label for="pay">Mode of Payment</label>
                    <div class="dropdown">
                      <button
                        class="btn btn-default dropdown-toggle"
                        type="button"
                        id="pay"
                        data-toggle="dropdown"
                        style="
                          width: 100%;
                          display: flex;
                          justify-content: space-between;
                          align-items: center;
                        "
                      >
                        Mode of Payment <span class="caret"></span>
                      </button>
                      <ul class="dropdown-menu" style="width: 100%">
                        <li onclick="setMode('UPI')"><a>UPI</a></li>
                        <li onclick="setMode('Net Banking')"><a>Net Banking</a></li>
                      </ul>
                    </div>
                  </div>
                  
                  <button class="btn btn-primary btn-block" onclick="handleSubmit()">
                    Pay Now 
                  </button>
              <!-- </form> -->
              <br />
            
          </div>
      </div>
  </div>
  <script>
    const _3A_COST = 3000;
    const _2A_COST = 2000;
    const _1A_COST = 1000;
    const _SL_COST = 500;

    const searchParams = new URLSearchParams(window.location.search);
    const email = searchParams.get("email");
    const mobileNumber = searchParams.get("mobileNumber");
    const passengerDetails = JSON.parse(searchParams.get("passengerDetails"));
    const bookedSeatsByClass = JSON.parse(JSON.parse(searchParams.get("bookedSeatsByClass")));
    const selectedClass = JSON.parse(searchParams.get("selectedClass"));


    const numPassengerComponent = document.getElementById("number-passenger");
    const selectedClassesComponent = document.getElementById("selected-classes");
    const priceComponent = document.getElementById("price");

    let price = 0;
    bookedSeatsByClass[selectedClass].forEach(className => {
      if (className == "3A") price += _3A_COST;
      else if (className == "2A") price += _2A_COST;
      else if (className = "1A") price += _1A_COST;
      else price += _SL_COST;
    })

    numPassengerComponent.textContent = passengerDetails.length;
    selectedClassesComponent.textContent = bookedSeatsByClass[selectedClass].join(", ");
    priceComponent.textContent = price;

    let mode = "";
    function setMode(modeValue) {
      const payComponent = document.getElementById("pay");
      payComponent.textContent = modeValue;
      mode = modeValue;
    }

    async function handleSubmit(e) {
      // e.preventDefault();
      const enteredPriceComponent = document.getElementById("input-price");
      const enteredPrice = enteredPriceComponent.value;
      console.log(enteredPrice)
      if (enteredPrice != price) {
        alert("Entered price is not correct");
        return;
      }
      const pnr = await createTicket();
      alert("Ticket Created!")
      window.location.href = `view-booked-detail?pnr=${pnr}`;
    }

    function generatePNR() {
        return Math.floor(1000000000 + Math.random() * 9000000000).toString();
      }

      console.log(passengerDetails.length);

    async function createTicket() {
      const pnr = generatePNR();
      const createTicketResponse = await fetch(`/api/create-ticket?pnr=${pnr}&trainId=123&paymentMethod=${mode}&amount=${price}&passengerEmail=${email}&passengerMobileNumber=${mobileNumber}`);
      // passengerDetails.forEach(async passenger => {
      //   const name = passenger.passengerName;
      //   const age = passenger.age;
      //   const gender = passenger.gender;
      //   const addPassengerResponse = await fetch(`/api/add-user?pnr=${PNR}&name=${name}&age=19&gender=male&preference=upper&className=UP&price=2000&seatNumber=SUB1`)
      // });

      console.log(passengerDetails);

      for (let i = 0; i < passengerDetails.length; i++) {
        console.log(i);
        const passenger = passengerDetails[i];
        const name = passenger.passengerName;
        const age = passenger.age;
        const gender = passenger.gender;
        const seat = bookedSeatsByClass[selectedClass][i];
        const className = seat.substring(0, seat.length - 1);
        let preference = "";
        if (className == "SUB" || className == "UB") preference = "upper";
        else if (className == "SLB" || className == "LB") preference = "lower";
        const addPassengerResponse = await fetch(`/api/add-user?pnr=${pnr}&name=${name}&age=${age}&gender=${gender}&preference=${preference}&className=${className}&price=${price}&seatNumber=${seat}`)
        console.log(addPassengerResponse);
      }
      return pnr;
    }

    console.log(price);
  </script>

    <!-- View Booked Ticket - Go to
    <a href="view-booked-detail-page.html">View Booked Ticket Page</a> -->
  </body>
</html>
